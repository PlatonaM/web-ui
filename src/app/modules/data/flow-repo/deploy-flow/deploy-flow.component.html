<!--
  ~ Copyright 2020 InfAI (CC SES)
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<div class="main-panel">
    <button mat-raised-button *ngIf="!editMode && ready" (click)="switchToClassic()" color="accent" class="layout-margin">Use classic deployment
    </button>
    <div class="layout-margin" fxLayout="column" *ngIf="ready == true" [formGroup]="form">
        <mat-accordion class="example-headers-align" multi>
            <mat-expansion-panel expanded>
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <div fxLayout="row" fxLayoutAlign="none center">
                            <mat-icon>folder</mat-icon>
                            <div fxFlexOffset="5px">General</div>
                        </div>
                    </mat-panel-title>
                    <mat-panel-description>
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <ng-template matExpansionPanelContent>
                    <div fxLayout="column">
                        <mat-form-field fxFlex color="accent" appearance="outline">
                            <mat-label>Name</mat-label>
                            <input matInput formControlName="name" placeholder="Name">
                        </mat-form-field>
                        <mat-form-field fxFlex color="accent" appearance="outline">
                            <mat-label>Description</mat-label>
                            <input matInput formControlName="description" placeholder="Description">
                        </mat-form-field>
                    </div>
                </ng-template>
            </mat-expansion-panel>
            <mat-expansion-panel *ngFor="let node of getSubElementAsGroupArray(form, 'nodes'); let nodeIndex = index"
                                 [formGroup]="node">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <div fxLayout="row" fxLayoutAlign="none center">
                            <mat-icon>poll</mat-icon>
                            <div fxFlexOffset="5px">{{node.get('name')?.value}}</div>
                        </div>
                    </mat-panel-title>
                    <mat-panel-description>
                        {{node.get('id')?.value}}
                    </mat-panel-description>
                </mat-expansion-panel-header>
                    <div fxLayout="column"
                         *ngFor="let input of getSubElementAsGroupArray(node, 'inputs'), let inputIndex = index"
                         [formGroup]="input">
                        <h4>{{ input.get('name')?.value }}</h4>
                        <mat-form-field fxFlex color="accent" appearance="outline">
                            <mat-label>Aspect</mat-label>
                            <senergy-select-search [options]="this.aspects"
                                                   useOptionViewProperty="name"
                                                   placeholder="Aspect"
                                                   useOptionValueProperty="id"
                                                   formControlName="aspectId">
                            </senergy-select-search>
                        </mat-form-field>
                        <mat-form-field fxFlex color="accent" appearance="outline">
                            <mat-label>Function</mat-label>
                            <senergy-select-search
                                    [options]="getAspectFunctions(input.get('aspectId')?.value)"
                                    useOptionViewProperty="name"
                                    placeholder="Function"
                                    useOptionValueProperty="id"
                                    formControlName="functionId"
                                    [autoSelectSingleElement]="true"
                                >
                            </senergy-select-search>
                        </mat-form-field>
                        <mat-form-field fxFlex color="accent" appearance="outline">
                            <mat-label>Characteristics</mat-label>
                            <senergy-select-search
                                    [options]="getFunctionCharacteristics(input.get('functionId')?.value)"
                                    useOptionViewProperty="name"
                                    placeholder="characteristics"
                                    useOptionValueProperty="id"
                                    formControlName="characteristics"
                                    [autoSelectSingleElement]="true"
                                    [multiple]="true"
                            >
                            </senergy-select-search>
                        </mat-form-field>
                        <mat-form-field fxFlex color="accent" appearance="outline">
                            <mat-label>Device/Group</mat-label>
                            <senergy-select-search
                                    [options]="getSelectables(input.get('aspectId')?.value, input.get('functionId')?.value, input.get('characteristics')?.value)"
                                    useOptionViewProperty="name"
                                    useOptionValueProperty="id"
                                    placeholder="Device/Group"
                                    formControlName="selectableId"
                            >
                            </senergy-select-search>
                        </mat-form-field>
                        <div fxFlex fxLayout="row" *ngFor="let deviceType of getSubElementAsGroupArray(input, 'deviceTypes')" [formGroup]="deviceType">
                            <mat-form-field fxFlex color="accent" appearance="outline">
                                <mat-label [ngClass]="{'device-type-not-used-label': getServiceOptions(input, deviceType.get('id')?.value).size === 0}">
                                    {{getServiceOptions(input, deviceType.get('id')?.value).size > 0 ? 'Service/Path: ' + deviceType.get('name')?.value
                                    :  deviceType.get('name')?.value + ' will not be used: no matching characteristic!'}}</mat-label>
                                <senergy-select-search placeholder="Service"
                                                       [multiple]="true"
                                                       [options]="getServiceOptions(input, deviceType.get('id')?.value)"
                                                       [autoSelectSingleElement]="true"
                                                       [getTriggerValue]="getServiceTriggerValue"
                                                       [compareWith]="comparePathOptions"
                                                       [getOptionDisabled]="getServiceOptionDisabledFunction(deviceType)"
                                                       formControlName="selection"
                                                       useOptionViewProperty="path">
                                </senergy-select-search>
                            </mat-form-field>
                        </div>
                    </div>
                    <h4 *ngIf="getSubElementAsGroupArray(node, 'configs').length > 0">Configuration</h4>
                    <div fxLayout="column" *ngFor="let config of getSubElementAsGroupArray(node, 'configs')"
                         [formGroup]="config">
                        <mat-form-field fxFill color="accent" appearance="outline">
                            <mat-label>{{ config.get('name')?.value }}</mat-label>
                            <input matInput formControlName="value"
                                   placeholder="{{config.get('name')?.value}}">
                        </mat-form-field>
                    </div>
            </mat-expansion-panel>
            <!--
            Global Settings
            -->
            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <div fxLayout="row" fxLayoutAlign="none center">
                            <mat-icon>settings</mat-icon>
                            <div fxFlexOffset="5px">Global Settings</div>
                        </div>
                    </mat-panel-title>
                    <mat-panel-description>
                        Only change, if you know what you are doing
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <mat-form-field class="full-width" color="accent" appearance="outline">
                    <mat-label>Window Time</mat-label>
                    <input matInput formControlName="windowTime" placeholder="Window Time">
                </mat-form-field>
                <section class="checkbox-section">
                    <mat-checkbox class="checkbox-margin" formControlName="enable_metrics">Enable Metrics</mat-checkbox>
                    <mat-checkbox class="checkbox-margin" formControlName="consume_all_msgs">Consume all messages
                    </mat-checkbox>
                </section>
            </mat-expansion-panel>
        </mat-accordion>

        <div fxLayout="row" fxLayoutAlign="start center" style="margin-top:8px;">
            <button mat-raised-button color="accent" (click)="startPipeline()">{{editMode ? 'Update' : 'Start'}}</button>
        </div>
    </div>
    <senergy-spinner [show]="!ready"></senergy-spinner>
</div>
